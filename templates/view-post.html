  {% extends 'base.html' %}

  {% block title %}Storenet | {{ post.title }}{% endblock %}

  {% block body %}
  <br>
  <div class='container-fluid'>
    <div class="row">
      <div class="col-xs-12 col-md-6 col-lg-7 offset-1">
        <div class="card">
          <div class="card-body">
            <!-- POSTS GO HERE -->
            <h3>Post</h3>
            <h4 class="card-title">{{ post.title }}</h4>
            <h6 class="card-subtitle mb-2 text-muted">Posted on {{ post.date.strftime('%a, %m.%d.%y') }} | Filed under {{ post.category.name }}</h6>
            <div class='pdf'>
             {% if post.pdf_url %}
                  <img src='/static/images/pdf.png' width='25px'> <a href="{{ post.pdf_url }}">{{ post.pdf_url }}</a>
                  {% else %}
                  no pdf
                  {% endif %}
                </div>
            <br>
            <p>{{ post.text }}</p>
            <!-- END POSTS SECTION -->
          </div>
        </div>
      </div><!--col-->
      <div class="col-xs-12 col-md-6 col-lg-3">
          <!-- TASKS SECTION -->
          <div class='card'><div class='card-body'>
          {% if post.tasks %}
            <h3>Tasks</h3>
            This task is due on <b>{{ task.deadline }}</b>. Status: 
            {% if task.is_complete == False %}
                <span class="badge badge-danger">INCOMPLETE</span>

            {% else %}
                Completed on {{ task.complete_date }}
            {% endif %}

            {% if task.emp_id == session['emp_id'] %}
              This post is assigned to you.
            {% elif task.emp_id %}
                This task is already assigned to {{ task.employee.fname }}.
            {% else %}
                Assign this task to an associate:
                <form action='/assign-task' method='post'>
                  <select name='assignee' required>
                    <option selected disabled value="">Select an Employee</option>
                    {% for employee in task.store.employees %}
                    <option value='{{ employee.emp_id }}'>{{ employee.fname }} {{ employee.lname }} - {{ employee.position.title }}</option>
                    {% endfor %}
                  </select>
                    <input type='hidden' name='post_id' value='{{ post.post_id }}'>
                    <input type='submit'>
                </form>
            {% endif %}

          {% else %}
              <small>No post is informational only. There is no task associated with tihs post. However, you must share the information with your fellow managers.</small>
          {% endif %}
          </div></div><!--card and body -->
         <!-- END TASK SECTION -->
        <div class="card">
          <div class="card-body">
            <h3>Who has read this post?</h3>
                  <small>
                    {% for emp in emps_read %}
                    <input type='checkbox' checked disabled>{{ emp.fname }}<br>
                    {% endfor %}
                    {% for emp in emps_not_read %}
                    <input type='checkbox' disabled>{{ emp.fname }}<br>
                    {% endfor %}
                  </small>
          </div></div><!--card body and card--> 
               

          <!-- DATA VIZ -->
          <h3>Post Views (all company)</h3>
          <a href='/logout'>Log Out</a>
                <div id="content"></div>

           <svg id='read-chart'></svg>
            <h3>Task completion (all_company)</h3>
           <svg id='task-chart'></svg>
           <svg id='dis'></svg>
          <!-- END DATA VIZ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  </div><!--row-->
</div><!--container-->


<!-- D3 Data Visualization here-->
<script type="text/javascript">
  'use strict';

function createRadialChart(url) {
  d3.json(url, function (results) {

  let color = d3.scale.ordinal()
    .range(['orange', 'steelblue']);

  let radius = 50;
  let border = 3;
  let startPercent = 0;
  let endPercent = results.data.percent/100;
  let formatPercent = d3.format('.0%');
  let canvas = radius * 2 + 10;

  let count = Math.abs((endPercent - startPercent) / 0.01);
  let step = endPercent < startPercent ? -0.01 : 0.01;

  let arc = d3.svg.arc()
    .startAngle(0)
    .innerRadius(radius)
    .outerRadius(radius - border);

  let parent = d3.select(results.div);

  let svg = parent.append('svg')
    .attr('width', canvas)
    .attr('height', canvas);

  let defs = svg.append('defs');

  let g = svg.append('g')
    .attr('transform', 'translate(' + canvas / 2 + ',' + canvas / 2 + ')');

  let innerCircle = g.append('g')
    .attr('class', 'progress-meter');

  innerCircle.append('path')
    .attr('fill', '#c0c0c0')
    .attr('d', arc.endAngle(Math.PI * 2));

  let foreground = innerCircle.append('path')
    .attr('fill', color)
    .attr('stroke', color)
    .attr('stroke-width', 5)

  let front = innerCircle.append('path')
    .attr('class', 'foreground')
    .attr('fill', color())

  let text = innerCircle.append('text')
    .attr('fill', 'black')
    .attr('text-anchor', 'middle')
    .attr('dy', '.35em')

  function updateProgress(progress) {
    foreground.attr('d', arc.endAngle(Math.PI * 2 * progress));
    front.attr('d', arc.endAngle(Math.PI * 2 * progress));
    text.text(formatPercent(progress));
  }

  let progress = startPercent;

  (function loops() {
    updateProgress(progress);

    if (count > 0) {
        count--;
        progress += step;
        setTimeout(loops, 10);
    }
})()});
};

createRadialChart('/posts/{{ post.post_id }}/read-compliance.json')
createRadialChart('/posts/{{ post.post_id }}/task-completion.json')


function createChart(url) {

  d3.json(url, function (results) {
      
      let data = results
      let formatPercent = d3.format('.0%');

      let chartWidth = 500,
          barHeight = 75;

      let scale = d3.scale.linear()
          .domain([0, 100])
          .range([0, chartWidth]);

      let color = d3.scale.linear()
          .domain([0, 100])
          .range(['orange', 'steelblue']);

      let chart = d3.select('#dis')
          .attr('width', chartWidth)
          .attr('height', barHeight * data.length * 2.5)

      let axis = d3.svg.axis()
          .ticks(3)
          .scale(scale);

      let bar = chart.selectAll('g')
          .data(data)
          .enter().append('g')
          .attr('transform', (d, i) => 'translate(0,' + i * barHeight + ')')

      bar.append('rect')
          .attr('width', 0)
          .transition()
          .duration(1000)
          .attr('width', (d) => scale(d.percent))
          .attr('height', barHeight - 3)
          .attr('fill', (d) => color(d.percent));

      bar.append('text')
          .attr('x', (d) => scale(d.percent) - 3)
          .attr('y', barHeight / 2)
          .attr('dy', '.2em')
          .text((d) => d.district + ' ' + formatPercent(d.percent/100));

      chart.append('g')
          .attr('transform', 'translate(0, 50)')
        });
}

createChart('/districts/read-compliance.json');
createChart('/districts/task-completion.json')

</script>


{% endblock %}
