{% extends 'base.html' %}

{% block title %}Welcome to Storenet{% endblock %}

{% block body %}
<div class='container-fluid'>
  <div class="row">
    <div class="col-xs-12 col-md-6 col-lg-9">
      <div class="panel panel-default">
        <!-- POSTS GO HERE -->
            <div class="panel-heading">
              <h3 class="panel-title">{{ post.title }}</h3>
              <small>Read by 
                {% for emp in emps_read %}
                {{ emp.fname }}
                {% endfor %}
              </small>
            </div>
          <div class="panel-body">
            {% if post.pdf_url %}
              There is an attachment associated with this post: <a href="{{ post.pdf_url }}">{{ post.pdf_url}}</a>
              {% else %}
              no pdf
              {% endif %}

            <p>{{ post.text }}</p>
          </div>
        <!-- END POSTS SECTION -->
      </div>
    </div>
    <div class="col-xs-12 col-md-6 col-lg-3">
      <div class="panel panel-default">
        <div class="panel-body">
        <!-- TASKS SECTION -->
        {% if post.tasks %}
          This task is due on <b>{{ task.deadline }}</b>. Status: 
          {% if task.complete == False %}
              <span id='flash'>INCOMPLETE.</span>
          {% else %}
              Completed on {{ task.complete_date }}
          {% endif %}
          <br>

          {% if task.emp_id %} <!-- QUESTION: Again, why is this a list? -->
              This task is already assigned to {{ task.employee.fname }}.
          {% else %}
              Assign this task to an associate:
              <form action='/assign-task' method='post'>
                  {% for employee in task.store.employees %}
                  <input type='radio' name='assignee' value='{{ employee.emp_id }}'>{{ employee.fname }} {{ employee.lname }} - {{ employee.position.title }}<br>
                  {% endfor %}
                  <input type='hidden' name='post_id' value='{{ post.post_id }}'>
                  <input type='submit'>
              </form>
        {% endif %}

        {% else %}
            No task is required on this. Go get a coffee.
        {% endif %}
        <!-- END TASK SECTION -->
        <!-- DATA VIZ -->
        <h3>Post Views (all company)</h3>
          <div id='read-chart'></div>
          <h3>Task completion (all_company)</h3>
          <div id='task-chart'></div>
        <!-- END DATA VIZ -->
        </div>
      </div>
    </div>
  </div>
</div>



<!-- D3 Data Visualization here-->
<script type="text/javascript">
    'use strict';

  d3.json('/read-{{ post.post_id }}.json', function(data) {
    let r = 100;

    let color = d3.scale.ordinal()
        .range(['blue', 'gray']);

    let canvas = d3.select('#read-chart').append('svg')
        .attr('width', 200)
        .attr('height', 200)
        .append('g')
        .attr('transform', 'translate(100, 100)');

    // Create the circle
    let arc = d3.svg.arc() 
        .innerRadius(0)
        .outerRadius(r);

    // Create the paths
    let pie = d3.layout.pie()
        .value((d) => d.count);

    let wedgies = canvas.selectAll('arc')
        .data(pie(data))
        .enter()
            .append('g')
            .attr('class', 'arc');

    wedgies.append('path')
        .attr('d', arc)
        .attr('fill', (d) => color(d.data.count))
        .text((d) => d.data.label);

    wedgies.append('text')
        .text((d) =>    d.data.count);                
});

  d3.json('/task-{{ post.post_id }}.json', function(data) {
    let r = 100;

    let color = d3.scale.ordinal()
        .range(['gray', 'green']);

    let canvas = d3.select('#task-chart').append('svg')
        .attr('width', 200)
        .attr('height', 200)
        .append('g')
        .attr('transform', 'translate(100, 100)');

    // Create the circle
    let arc = d3.svg.arc() 
        .innerRadius(0)
        .outerRadius(r);

    // Create the paths
    let pie = d3.layout.pie()
        .value((d) => d.count);

    let wedgies = canvas.selectAll('arc')
        .data(pie(data))
        .enter()
            .append('g')
            .attr('class', 'arc');

    wedgies.append('path')
        .attr('d', arc)
        .attr('fill', (d) => color(d.data.count));

    wedgies.append('text')
        .text((d) => d.data.count);               
});
</script>

{% endblock %}
